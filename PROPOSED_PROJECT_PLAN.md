# Proposed Project Plan: AngioSAM - A Multi-Stage Approach for Automated QCA

## 1. Executive Summary

This document outlines a comprehensive, three-stage training plan to develop `AngioSAM`, a specialized AI model for automated Quantitative Coronary Angiography (QCA). The model will leverage the Segment Anything Model (SAM 3) to perform vessel segmentation, CASS segment classification, and stenosis quantification.

The core strategy is a **context-aware, pre-training and fine-tuning approach**. We first teach the model general coronary anatomy (the "map") and then fine-tune it to identify specific locations ("addresses") and analyze their condition. This plan is designed to be robust, efficient, and directly address the complexities of anatomical variability and view-angle dependence inherent in coronary angiography.

## 2. Core Philosophy: From General Anatomy to Specific Pathology

The plan is built on the following principles:

- **Anatomical Context is Mandatory:** A model cannot identify a specific CASS segment without first understanding its place within the larger coronary tree. Our first stage is dedicated to building this foundational anatomical knowledge.
- **Progressive Learning:** The model learns in a logical sequence: from "What is a vessel?" (Stage 1), to "Which specific vessel is this?" (Stage 2), and finally to "Is this vessel diseased, and how severely?" (Stage 3).
- **Multi-Task Learning:** To ensure knowledge is retained between stages, the model is trained on multiple objectives simultaneously. For instance, while learning to classify CASS segments in Stage 2, it will continue to practice the full vessel segmentation task learned in Stage 1.
- **Leverage SAM 3's Strengths:** The plan utilizes SAM 3's powerful segmentation backbone and its ability to be fine-tuned with specialized prediction "heads" for custom tasks like classification and regression.

---

## 3. Stage-by-Stage Implementation Plan

### **Stage 1: Foundational Anatomy Pre-training (Full Vessel Segmentation)**

- **Goal:** To create a foundational model that understands the general appearance, shape, and structure of the entire coronary artery tree.
- **Method:** Train a base SAM 3 model using the high-quality pseudo-labels generated by the pre-trained DeepSA model. This provides a massive, domain-specific dataset for learning what constitutes a "vessel".
- **Script:** `train_stage1_deepsa.py`
- **Status:** ✅ **COMPLETED**
- **Outcome:** A model checkpoint (`checkpoints/phase1_deepsa_best.pth`) that achieves a **0.8 Dice score** on full vessel segmentation. This model serves as the expert anatomical foundation for all subsequent stages.

---

### **Stage 2: Context-Aware CASS Segment Fine-tuning**

- **Goal:** To fine-tune the anatomically-aware model from Stage 1 to accurately identify and localize specific CASS segments (1-29), accounting for viewing angle.
- **Method:** We will load the weights from the Stage 1 model and continue training on the expert-annotated Medis dataset. The model's task is to use its full-tree knowledge to pinpoint a specific segment.
- **Script:** `train_stage2_cass_segments.py`
- **Architecture (`SAM3CASSModel`):**
    1.  **Backbone:** The SAM 3 model, initialized with the weights from Stage 1.
    2.  **View Encoder:** The `CategoricalViewEncoder` will process the RAO/LAO and Cranial/Caudal angles, which is critical for this task.
    3.  **New Prediction Heads:**
        *   A **CASS Classification Head** (MLP) will be added to predict the correct CASS segment ID.
        *   A **Bounding Box Regression Head** (MLP) will be added to predict the location and size of the segment.
- **Key Training Inputs:**
    - **Image:** The angiography frame.
    - **View Angles:** To handle appearance changes based on viewpoint.
    - **Ground Truth Targets:**
        - CASS Segment ID (from `corrected_dataset_training.csv`).
        - Bounding Box of the segment (derived from Medis contours).
        - Full vessel mask (from DeepSA pseudo-labels) to continue the segmentation task.
- **Loss Function:** A combined, multi-task loss function:
    - `Segmentation Loss` (Dice + BCE): Ensures the model does not forget the foundational learning from Stage 1.
    - `Classification Loss` (Cross-Entropy): To train the CASS classification head.
    - `Regression Loss` (Smooth L1): To train the bounding box head.
- **Expected Outcome:** A model checkpoint that can accurately classify and localize specific CASS segments, achieving >90% validation accuracy on the classification task.

---

### **Stage 3: Lesion Quantification (Stenosis Detection)**

- **Goal:** To equip the model with the final ability to detect and quantify lesions within the identified CASS segments, providing a full, automated QCA analysis.
- **Method:** We will load the Stage 2 model and add two final prediction heads, training them on the precise measurement data from the Medis JSON files.
- **Architecture:**
    1.  **Backbone:** The fine-tuned, context-aware model from Stage 2.
    2.  **New Prediction Heads:**
        *   A **Stenosis Heatmap Head** (Convolutional): This head will learn to predict a heatmap that localizes the lesion, with the highest intensity at the point of maximum stenosis (MLD). The ground truth for this can be generated from the lesion coordinates in the Medis data.
        *   A **Stenosis Regression Head** (MLP): This head will directly predict the key clinical measurements:
            - `diameter_stenosis_pct`
            - `MLD_mm`
            - `lesion_length_mm`
- **Key Training Inputs:**
    - The same inputs as Stage 2.
    - **Ground Truth Targets:**
        - Generated lesion heatmaps.
        - Clinical measurement values from the Medis data.
- **Loss Function:** Another multi-task loss, adding MSE or Smooth L1 loss for the new heatmap and regression heads. At this point, we might lower the weight of the original segmentation loss to focus the model more on the final quantification tasks.
- **Expected Outcome:** A final `AngioSAM` model capable of performing a full, automated QCA analysis on a given angiography frame.

---

## 4. Overall Architecture & Data Flow

```
Input Frame + View Angles
       │
       ▼
┌───────────────────────────────────────────────────────────┐
│              AngioSAM (Fine-tuned SAM 3 Model)            │
│ ───────────────────────────────────────────────────────── │
│  (Backbone pre-trained on DeepSA pseudo-labels in Stage 1)│
│                                                           │
│ ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐│
│ │   CASS Class.   │  │  BBox Regress.  │  │  Stenosis Reg. ││
│ │      Head       │  │      Head       │  │      Head      ││
│ └─────────────────┘  └─────────────────┘  └────────────────┘│
│         │                  │                    │         │
└─────────┼──────────────────┼────────────────────┼─────────┘
          │                  │                    │
          ▼                  ▼                    ▼
   CASS Segment ID      Segment BBox       Stenosis %, MLD, etc.
      (e.g., 13)      [x, y, w, h]         (e.g., 75%, 1.2mm)
```

## 5. Immediate Next Steps

1.  **Confirm Stage 1 Checkpoint:** Ensure the `checkpoints/phase1_deepsa_best.pth` file is ready.
2.  **Prepare for Stage 2:** Review the `train_stage2_cass_segments.py` script to ensure it correctly loads the Stage 1 checkpoint and that the hyperparameters (especially the learning rate, which should be lower for fine-tuning) are set appropriately.
3.  **Initiate Stage 2 Training:** Run the `train_stage2_cass_segments.py` script to begin fine-tuning the model for CASS segment classification.
4.  **Monitor Stage 2:** Closely watch the validation accuracy for the CASS classification task to track progress.
